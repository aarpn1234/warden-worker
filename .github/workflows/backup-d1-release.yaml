name: Backup D1 Database to release

on:
  schedule:
    - cron: "0 4 * * *"
  workflow_dispatch:

jobs:
  backup-production:
    name: Backup Production D1 Database
    runs-on: ubuntu-latest

    steps:
      # Áªô gh CLI Êèê‰æõ‰ªìÂ∫ì‰∏ä‰∏ãÊñáÔºàÂøÖÈ°ªÔºâ
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT

      - name: Install wrangler
        run: npm install -g wrangler

      - name: Get D1 Database Name
        id: db_name
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          DB_NAME=$(npx wrangler d1 list --json | jq -r '.[] | select(.uuid == "${{ secrets.D1_DATABASE_ID }}") | .name')
          if [ -z "$DB_NAME" ]; then
            echo "‚ùå Error: Could not find database with D1_DATABASE_ID secret"
            exit 1
          fi
          echo "db_name=$DB_NAME" >> $GITHUB_OUTPUT

      - name: Export D1 Database
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Exporting D1 database..."
          npx wrangler d1 export "${{ steps.db_name.outputs.db_name }}" \
            --remote \
            --output=backup.sql

          gzip backup.sql

      - name: Encrypt backup (required)
        id: encrypted
        env:
          BACKUP_ENCRYPTION_KEY: ${{ secrets.BACKUP_ENCRYPTION_KEY }}
        run: |
          if [ -z "$BACKUP_ENCRYPTION_KEY" ]; then
            echo "‚ùå ERROR: BACKUP_ENCRYPTION_KEY is not set"
            exit 1
          fi

          OUTFILE="vault1_prod_${{ steps.date.outputs.date }}.sql.gz.enc"

          openssl enc -aes-256-cbc -salt -pbkdf2 -iter 100000 \
            -in backup.sql.gz \
            -out "$OUTFILE" \
            -pass pass:"$BACKUP_ENCRYPTION_KEY"

          echo "outfile=$OUTFILE" >> $GITHUB_OUTPUT
          rm backup.sql.gz

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "backup-${{ steps.date.outputs.date }}"
          name: "Backup ${{ steps.date.outputs.date }}"
          files: "${{ steps.encrypted.outputs.outfile }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete old backup releases (keep latest 3)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          KEEP=3
          echo "üßπ Keeping latest $KEEP backup releases..."

          gh release list --limit 100 --json name,createdAt |
          jq -r '
            map(select(.name | startswith("Backup "))) |
            sort_by(.createdAt) |
            reverse |
            .['"$KEEP"':] |
            .[] |
            .name
          ' |
          while read -r name; do
            echo "üóëÔ∏è Deleting old backup release: $name"
            gh release delete "$name" -y
          done
